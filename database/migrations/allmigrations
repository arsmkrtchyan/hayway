<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->decimal('number', 20,0)->nullable();
            $table->decimal('rating',10,2)->default(5);
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->string('icon')->nullable(); // for client
            $table->rememberToken();
            $table->timestamps();
        });

        Schema::create('password_reset_tokens', function (Blueprint $table) {
            $table->string('email')->primary();
            $table->string('token');
            $table->timestamp('created_at')->nullable();
        });

        Schema::create('sessions', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->foreignId('user_id')->nullable()->index();
            $table->string('ip_address', 45)->nullable();
            $table->text('user_agent')->nullable();
            $table->longText('payload');
            $table->integer('last_activity')->index();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('users');
        Schema::dropIfExists('password_reset_tokens');
        Schema::dropIfExists('sessions');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('cache', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->mediumText('value');
            $table->integer('expiration');
        });

        Schema::create('cache_locks', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->string('owner');
            $table->integer('expiration');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('cache');
        Schema::dropIfExists('cache_locks');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('jobs', function (Blueprint $table) {
            $table->id();
            $table->string('queue')->index();
            $table->longText('payload');
            $table->unsignedTinyInteger('attempts');
            $table->unsignedInteger('reserved_at')->nullable();
            $table->unsignedInteger('available_at');
            $table->unsignedInteger('created_at');
        });

        Schema::create('job_batches', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->string('name');
            $table->integer('total_jobs');
            $table->integer('pending_jobs');
            $table->integer('failed_jobs');
            $table->longText('failed_job_ids');
            $table->mediumText('options')->nullable();
            $table->integer('cancelled_at')->nullable();
            $table->integer('created_at');
            $table->integer('finished_at')->nullable();
        });

        Schema::create('failed_jobs', function (Blueprint $table) {
            $table->id();
            $table->string('uuid')->unique();
            $table->text('connection');
            $table->text('queue');
            $table->longText('payload');
            $table->longText('exception');
            $table->timestamp('failed_at')->useCurrent();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('jobs');
        Schema::dropIfExists('job_batches');
        Schema::dropIfExists('failed_jobs');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('role')->default('client'); // client|driver|company|admin
            $table->string('admin_status')->default('approved'); // approved|pending|rejected
            $table->string('avatar_path')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn(['role','admin_status','avatar_path']);
        });
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('drivers', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->constrained()->cascadeOnDelete();
            $table->decimal('rating',10,2)->default(5);
            $table->string('selfie_path')->nullable();
            $table->string('car_photo_path')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('drivers');
    }
};
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;


return new class extends Migration {
    public function up(): void {
        Schema::create('vehicles', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->constrained()->cascadeOnDelete();
            $table->string('brand'); // օրինակ՝ Toyota
            $table->string('model'); // օրինակ՝ Camry
            $table->unsignedTinyInteger('seats')->default(4); // ուղևորների տեղերը
            $table->string('color')->nullable(); // hex կամ անվանում
            $table->string('plate')->nullable(); // պետ. համարանիշ
            $table->string('photo_path')->nullable();
            $table->string('status')->default('active'); // active|archived
            $table->timestamps();
        });
    }
    public function down(): void { Schema::dropIfExists('vehicles'); }
};
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;


return new class extends Migration {
    public function up(): void {
        Schema::create('trips', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->constrained()->cascadeOnDelete(); // վարորդ
            $table->foreignId('vehicle_id')->constrained()->cascadeOnDelete();
            $table->decimal('from_lat',10,7)->nullable();
            $table->decimal('from_lng',10,7)->nullable();
            $table->string('from_addr');
            $table->decimal('to_lat',10,7)->nullable();
            $table->decimal('to_lng',10,7)->nullable();
            $table->string('to_addr');
            $table->dateTime('departure_at');
            $table->unsignedTinyInteger('seats_total');
            $table->unsignedTinyInteger('seats_taken')->default(0);
            $table->unsignedInteger('price_amd');
            $table->json('pay_methods')->nullable(); // ["cash","card"]
            $table->string('status')->default('draft'); // draft|published|archived|cancelled
            $table->timestamps();
        });
    }
    public function down(): void { Schema::dropIfExists('trips'); }
};
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;


return new class extends Migration {
    public function up(): void {
        Schema::create('ride_requests', function (Blueprint $table) {
            $table->id();
            $table->foreignId('trip_id')->constrained()->cascadeOnDelete();
            $table->string('passenger_name')->nullable();
            $table->string('phone')->nullable();
            $table->text('description')->nullable();
            $table->unsignedTinyInteger('seats')->default(1);
            $table->string('payment'); // cash|card
            $table->string('status')->default('pending'); // pending|accepted|rejected|cancelled
            $table->timestamps();
        });
    }
    public function down(): void { Schema::dropIfExists('ride_requests'); }
};
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::table('ride_requests', function (Blueprint $table) {
            // если таблица уже существует без user_id — добавляем
            if (!Schema::hasColumn('ride_requests', 'user_id')) {
                $table->foreignId('user_id')
                    ->nullable()                // чтобы старые записи не упали
                    ->constrained('users')      // FK -> users(id)
                    ->nullOnDelete();           // при удалении юзера — NULL
                $table->index('user_id');
            }
        });
    }

    public function down(): void
    {
        Schema::table('ride_requests', function (Blueprint $table) {
            if (Schema::hasColumn('ride_requests', 'user_id')) {
                $table->dropForeign(['user_id']);
                $table->dropIndex(['user_id']);
                $table->dropColumn('user_id');
            }
        });
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('companies', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->decimal('rating',10,2)->default(5);// անուն
            $table->string('email')->nullable();
            $table->foreignId('owner_user_id')      // ստեղծող/սեփականատեր
            ->constrained('users')->cascadeOnDelete();
            $table->string('status')->default('pending'); // pending|approved|rejected
            $table->string('logo_path')->nullable();
            $table->timestamps();
        });

        // many-to-many с ролью внутри компании
        Schema::create('company_members', function (Blueprint $table) {
            $table->id();
            $table->foreignId('company_id')->constrained()->cascadeOnDelete();
            $table->foreignId('user_id')->constrained()->cascadeOnDelete();
            $table->string('role')->default('driver'); // owner|dispatcher|driver
            $table->decimal('rating',10,2)->default(5);// անուն
            $table->timestamps();

            $table->unique(['company_id','user_id']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('company_members');
        Schema::dropIfExists('companies');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        // машины могут принадлежать либо юзеру, либо компании
        Schema::table('vehicles', function (Blueprint $table) {
            $table->foreignId('company_id')->nullable()->after('user_id') // nullable => back-compat
            ->constrained('companies')->nullOnDelete();
        });

        // рейс может быть от компании; и водитель может быть назначен
        Schema::table('trips', function (Blueprint $table) {
            $table->foreignId('company_id')->nullable()->after('driver_id')
                ->constrained('companies')->nullOnDelete();
            $table->foreignId('assigned_driver_id')->nullable()->after('driver_id')
                ->constrained('users')->nullOnDelete();
        });
    }

    public function down(): void
    {
        Schema::table('trips', function (Blueprint $table) {
            $table->dropConstrainedForeignId('company_id');
            $table->dropConstrainedForeignId('assigned_driver_id');
        });
        Schema::table('vehicles', function (Blueprint $table) {
            $table->dropConstrainedForeignId('company_id');
        });
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::table('ride_requests', function (Blueprint $table) {
            // audit: кто принял/отклонил заявку
            $table->foreignId('decided_by_user_id')->nullable()->after('status')
                ->constrained('users')->nullOnDelete();
            $table->timestamp('decided_at')->nullable()->after('decided_by_user_id');
        });
    }

    public function down(): void
    {
        Schema::table('ride_requests', function (Blueprint $table) {
            $table->dropConstrainedForeignId('decided_by_user_id');
            $table->dropColumn('decided_at');
        });
    }
};
<?php
// database/migrations/2024_01_01_000000_create_company_user_table.php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('company_user', function (Blueprint $table) {
            $table->id();
            $table->foreignId('company_id')->constrained()->cascadeOnDelete();
            $table->foreignId('user_id')->constrained()->cascadeOnDelete();
            $table->string('role')->default('driver'); // driver|manager|owner
            $table->timestamps();

            $table->unique(['company_id','user_id']); // чтобы не дублировались
        });
    }
    public function down(): void {
        Schema::dropIfExists('company_user');
    }
};

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::table('trips', function (Blueprint $table) {
            // состояние выполнения для назначенного водителя компании
            $table->string('driver_state')->default('assigned'); // assigned|en_route|done
            $table->timestamp('driver_started_at')->nullable();
            $table->timestamp('driver_finished_at')->nullable();
        });
    }

    public function down(): void {
        Schema::table('trips', function (Blueprint $table) {
            $table->dropColumn(['driver_state','driver_started_at','driver_finished_at']);
        });
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('personal_access_tokens', function (Blueprint $table) {
            $table->id();
            $table->morphs('tokenable');
            $table->text('name');
            $table->string('token', 64)->unique();
            $table->text('abilities')->nullable();
            $table->timestamp('last_used_at')->nullable();
            $table->timestamp('expires_at')->nullable()->index();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('personal_access_tokens');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('amenity_categories', function (Blueprint $table) {
            $table->id();
            $table->string('name', 120);
            $table->string('slug', 120)->unique();
            $table->unsignedInteger('sort_order')->default(0);
            $table->boolean('is_active')->default(true);
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('amenity_categories');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('amenities', function (Blueprint $table) {
            $table->id();
            $table->foreignId('amenity_category_id')
                ->nullable()
                ->constrained('amenity_categories')
                ->nullOnDelete();
            $table->string('name', 120);
            $table->string('slug', 120)->unique();
            $table->string('icon', 120)->nullable();
            $table->boolean('is_active')->default(true);
            $table->unsignedInteger('sort_order')->default(0);
            $table->jsonb('meta')->nullable();
            $table->timestamps();

            $table->index(['amenity_category_id', 'sort_order']);
            $table->unique(['amenity_category_id', 'name']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('amenities');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('amenity_trip', function (Blueprint $table) {
            $table->foreignId('trip_id')->constrained('trips')->cascadeOnDelete();
            $table->foreignId('amenity_id')->constrained('amenities')->cascadeOnDelete();
            $table->timestamp('selected_at')->default(DB::raw('now()'));
            $table->string('notes', 240)->nullable();
            $table->timestamps();

            $table->primary(['trip_id', 'amenity_id']);
            $table->index(['amenity_id', 'trip_id']); // для фильтров
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('amenity_trip');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('trip_stops', function (Blueprint $table) {
            $table->id();
            $table->foreignId('trip_id')->constrained()->cascadeOnDelete();

            // Порядок прохождения остановок: 1..N
            $table->unsignedSmallInteger('position')->default(1)->nullable();

            // Название и/или человекочитаемый адрес (по желанию)
            $table->string('name')->nullable();
            $table->string('addr')->nullable();

            // Координаты
            $table->decimal('lat', 10, 7);
            $table->decimal('lng', 10, 7);

            $table->timestamps();

            $table->unique(['trip_id', 'position']); // уникальный порядок внутри рейса
            $table->index(['trip_id']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('trip_stops');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('ratings', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('user_id');
            $table->foreign('user_id')->references('id')->on('users')->cascadeOnDelete();
            $table->unsignedBigInteger('trip_id');
            $table->foreign('trip_id')->references('id')->on('trips')->cascadeOnDelete();
            $table->decimal('rating',10,2)->default(5);
            $table->text('description')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('ratings');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::table('ratings', function (Blueprint $table) {
            // на всякий случай индексы
            $table->index(['trip_id']);
            $table->index(['user_id']);
        });
        // уникальный отзыв от пользователя на поездку
        Schema::table('ratings', function (Blueprint $table) {
            $table->unique(['trip_id','user_id']);
        });

        // ускорим выборки завершённых
        Schema::table('trips', function (Blueprint $table) {
            if (!Schema::hasColumn('trips','driver_finished_at')) return;
            $table->index(['driver_finished_at']);
            if (Schema::hasColumn('trips','company_id')) $table->index(['company_id']);
            if (Schema::hasColumn('trips','assigned_driver_id')) $table->index(['assigned_driver_id']);
            $table->index(['user_id']);
        });
    }

    public function down(): void {
        Schema::table('ratings', function (Blueprint $table) {
            $table->dropUnique(['trip_id','user_id']);
            $table->dropIndex(['ratings_trip_id_index']);
            $table->dropIndex(['ratings_user_id_index']);
        });
        Schema::table('trips', function (Blueprint $table) {
            $table->dropIndex(['trips_driver_finished_at_index']);
            if (Schema::hasColumn('trips','company_id')) $table->dropIndex(['trips_company_id_index']);
            if (Schema::hasColumn('trips','assigned_driver_id')) $table->dropIndex(['trips_assigned_driver_id_index']);
            $table->dropIndex(['trips_user_id_index']);
        });
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('conversations', function (Blueprint $t) {
            $t->id();
            $t->foreignId('ride_request_id')->unique()->constrained()->cascadeOnDelete();
            $t->foreignId('trip_id')->constrained()->cascadeOnDelete();
            $t->foreignId('driver_user_id')->constrained('users')->cascadeOnDelete();
            $t->foreignId('client_user_id')->constrained('users')->cascadeOnDelete();
            $t->string('status')->default('open'); // open|closed
            $t->unsignedBigInteger('last_message_id')->nullable();
            $t->timestamps();
            $t->index(['driver_user_id']);
            $t->index(['client_user_id']);
            $t->index(['status']);
        });

        Schema::create('conversation_participants', function (Blueprint $t) {
            $t->id();
            $t->foreignId('conversation_id')->constrained()->cascadeOnDelete();
            $t->foreignId('user_id')->constrained()->cascadeOnDelete();
            $t->string('role')->nullable(); // driver|client
            $t->unsignedBigInteger('last_read_message_id')->nullable();
            $t->timestamp('last_seen_at')->nullable();   // heartbeat
            $t->timestamp('typing_until')->nullable();   // "печатает" TTL
            $t->timestamps();
            $t->unique(['conversation_id','user_id']);
            $t->index(['last_seen_at']);
            $t->index(['typing_until']);
        });

        Schema::create('conversation_messages', function (Blueprint $t) {
            $t->id();
            $t->foreignId('conversation_id')->constrained()->cascadeOnDelete();
            $t->foreignId('sender_id')->constrained('users')->cascadeOnDelete();
            $t->string('client_mid', 100)->nullable(); // идемпотентность
            $t->text('body')->nullable();
            $t->string('attachment_path')->nullable();
            $t->string('attachment_mime')->nullable();
            $t->unsignedInteger('attachment_size')->nullable();
            $t->timestamp('edited_at')->nullable();
            $t->timestamp('deleted_at')->nullable(); // мягкое удаление
            $t->timestamps();
            $t->index(['conversation_id','created_at']);
            $t->index(['sender_id','created_at']);
            $t->unique(['conversation_id','sender_id','client_mid']);
        });

        Schema::create('chat_uploads', function (Blueprint $t) {
            $t->id();
            $t->foreignId('user_id')->constrained()->cascadeOnDelete();
            $t->string('path');
            $t->string('mime')->nullable();
            $t->unsignedInteger('size')->nullable();
            $t->timestamp('expires_at')->nullable();
            $t->timestamps();
            $t->index(['expires_at']);
        });
    }
    public function down(): void {
        Schema::dropIfExists('chat_uploads');
        Schema::dropIfExists('conversation_messages');
        Schema::dropIfExists('conversation_participants');
        Schema::dropIfExists('conversations');
    }
};

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        // conversations: один диалог на пару driver-client
        Schema::table('conversations', function (Blueprint $t) {
            // ride_request_id больше не уникален и может быть null
            if (Schema::hasColumn('conversations','ride_request_id')) {
                try { $t->dropUnique('conversations_ride_request_id_unique'); } catch (\Throwable $e) {}
                $t->unsignedBigInteger('ride_request_id')->nullable()->change();
            }
            // trip_id в самой беседе не нужен
            if (Schema::hasColumn('conversations','trip_id')) {
                $t->dropConstrainedForeignId('trip_id');
            }
            // уникальность пары
            $t->unique(['driver_user_id','client_user_id'],'conv_pair_unique');
            // ускорение сортировок
            if (!Schema::hasColumn('conversations','last_message_id')) {
                $t->unsignedBigInteger('last_message_id')->nullable()->after('status');
            }
            if (!Schema::hasColumn('conversations','updated_at')) {
                $t->timestamps();
            }
        });

        // messages: тип + мета
        Schema::table('conversation_messages', function (Blueprint $t) {
            if (!Schema::hasColumn('conversation_messages','type')) {
                $t->string('type', 20)->default('text')->after('client_mid'); // text|image|trip|system
            }
            if (!Schema::hasColumn('conversation_messages','meta')) {
                $t->json('meta')->nullable()->after('attachment_size'); // для trip/системных
            }
            $t->index(['conversation_id','id']);
        });

        // participants без изменений
    }

    public function down(): void
    {
        Schema::table('conversation_messages', function (Blueprint $t) {
            if (Schema::hasColumn('conversation_messages','meta')) $t->dropColumn('meta');
            if (Schema::hasColumn('conversation_messages','type')) $t->dropColumn('type');
        });
        Schema::table('conversations', function (Blueprint $t) {
            try { $t->dropUnique('conv_pair_unique'); } catch (\Throwable $e) {}
        });
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('trip_stop_requests', function (Blueprint $table) {
            $table->id();

            $table->foreignId('conversation_id')->constrained()->cascadeOnDelete();
            $table->foreignId('trip_id')->constrained()->cascadeOnDelete();

            $table->foreignId('requester_id')->constrained('users'); // обычно клиент
            $table->string('status')->default('pending'); // pending|accepted|declined|cancelled

            $table->string('name')->nullable();
            $table->string('addr')->nullable();
            $table->decimal('lat', 10, 7);
            $table->decimal('lng', 10, 7);

            // превью и итог
            $table->unsignedInteger('old_duration_sec')->nullable();
            $table->unsignedInteger('new_duration_sec')->nullable();
            $table->json('old_order')->nullable(); // [ {type:'from|stop|to', lat,lng,name,addr}, ... ]
            $table->json('new_order')->nullable();

            $table->foreignId('decided_by')->nullable()->constrained('users');
            $table->timestamp('decided_at')->nullable();

            $table->unsignedBigInteger('request_message_id')->nullable(); // ConversationMessage id
            $table->unsignedBigInteger('result_message_id')->nullable();  // ConversationMessage id

            $table->timestamps();

            $table->index(['conversation_id']);
            $table->index(['trip_id']);
            $table->index(['status']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('trip_stop_requests');
    }
};
<?php
// database/migrations/2025_09_16_000000_create_checkin_tickets_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
public function up(): void {
Schema::create('checkin_tickets', function (Blueprint $t) {
$t->id();
$t->string('token', 64)->unique();
$t->foreignId('ride_request_id')->constrained()->cascadeOnDelete();
$t->foreignId('trip_id')->constrained()->cascadeOnDelete();
$t->foreignId('client_user_id')->constrained('users')->cascadeOnDelete();
$t->foreignId('driver_user_id')->constrained('users')->cascadeOnDelete();
$t->timestamp('expires_at');
$t->timestamp('used_at')->nullable();
$t->timestamps();

$t->index(['driver_user_id','expires_at']);
$t->index(['ride_request_id','used_at']);
});
}
public function down(): void { Schema::dropIfExists('checkin_tickets'); }
};
<?php

// database/migrations/2025_09_16_000010_add_checkin_flags_to_ride_requests.php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::table('ride_requests', function (Blueprint $t) {
            $t->boolean('is_checked_in')->default(false)->after('status');
            $t->timestamp('checked_in_at')->nullable()->after('is_checked_in');
        });
    }
    public function down(): void {
        Schema::table('ride_requests', function (Blueprint $t) {
            $t->dropColumn(['is_checked_in','checked_in_at']);
        });
    }
};

<?php

use App\Enums\CompanyStatus;
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::table('companies', function (Blueprint $t) {
            if (!Schema::hasColumn('companies','slug')) {
                $t->string('slug')->nullable()->unique()->after('name');
            }
            if (!Schema::hasColumn('companies','phone')) {
                $t->string('phone', 60)->nullable()->after('email');
            }
            if (!Schema::hasColumn('companies','timezone')) {
                $t->string('timezone', 64)->nullable()->after('phone');
            }
            if (!Schema::hasColumn('companies','locale')) {
                $t->string('locale', 8)->nullable()->after('timezone');
            }
            if (!Schema::hasColumn('companies','currency')) {
                $t->string('currency', 8)->default('AMD')->after('locale');
            }
            if (!Schema::hasColumn('companies','settings')) {
                $t->json('settings')->nullable()->after('currency');
            }
            if (Schema::hasColumn('companies','status')) {
                $t->string('status')->default(CompanyStatus::PENDING->value)->change();
            }
            if (!Schema::hasColumn('companies','members_count')) {
                $t->unsignedInteger('members_count')->default(0)->after('logo_path');
            }

            $t->index(['status']);
            $t->index(['owner_user_id']);
        });
    }

    public function down(): void
    {
        Schema::table('companies', function (Blueprint $t) {
            if (Schema::hasColumn('companies','slug')) $t->dropColumn('slug');
            if (Schema::hasColumn('companies','phone')) $t->dropColumn('phone');
            if (Schema::hasColumn('companies','timezone')) $t->dropColumn('timezone');
            if (Schema::hasColumn('companies','locale')) $t->dropColumn('locale');
            if (Schema::hasColumn('companies','currency')) $t->dropColumn('currency');
            if (Schema::hasColumn('companies','settings')) $t->dropColumn('settings');
            if (Schema::hasColumn('companies','members_count')) $t->dropColumn('members_count');
        });
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('ride_request_transfers', function (Blueprint $t) {
            $t->id();
            $t->foreignId('ride_request_id')->constrained()->cascadeOnDelete();
            $t->foreignId('from_trip_id')->constrained('trips')->cascadeOnDelete();
            $t->foreignId('to_trip_id')->constrained('trips')->cascadeOnDelete();
            $t->foreignId('company_id')->constrained('companies')->cascadeOnDelete();
            $t->foreignId('transferred_by_user_id')->constrained('users')->cascadeOnDelete();
            $t->string('reason', 240)->nullable();
            $t->timestamp('transferred_at')->useCurrent();
            $t->timestamps();

            $t->index(['company_id','transferred_at']);
            $t->index(['from_trip_id']);
            $t->index(['to_trip_id']);
        });
    }
    public function down(): void
    {
        Schema::dropIfExists('ride_request_transfers');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('ride_request_transfers', function (Blueprint $t) {
            $t->id();
            $t->foreignId('ride_request_id')->constrained()->cascadeOnDelete();
            $t->foreignId('from_trip_id')->constrained('trips')->cascadeOnDelete();
            $t->foreignId('to_trip_id')->constrained('trips')->cascadeOnDelete();
            $t->foreignId('company_id')->constrained('companies')->cascadeOnDelete();
            $t->foreignId('transferred_by_user_id')->constrained('users')->cascadeOnDelete();
            $t->string('reason', 240)->nullable();
            $t->timestamp('transferred_at')->useCurrent();
            $t->timestamps();

            $t->index(['company_id','transferred_at']);
            $t->index(['from_trip_id']);
            $t->index(['to_trip_id']);
        });
    }
    public function down(): void
    {
        Schema::dropIfExists('ride_request_transfers');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::table('ride_requests', function (Blueprint $t) {
            if (!Schema::hasColumn('ride_requests','meta')) {
                $t->json('meta')->nullable()->after('status');
            }
            if (!Schema::hasColumn('ride_requests','decided_by_user_id')) {
                // на случай, если ещё не применялась твоя миграция аудита
                $t->foreignId('decided_by_user_id')->nullable()->after('meta')
                    ->constrained('users')->nullOnDelete();
                $t->timestamp('decided_at')->nullable()->after('decided_by_user_id');
            }
            $t->index(['trip_id','status']);
            $t->index(['user_id','status']);
        });
    }
    public function down(): void {
        Schema::table('ride_requests', function (Blueprint $t) {
            if (Schema::hasColumn('ride_requests','meta')) $t->dropColumn('meta');
            // индексы можно оставить
        });
    }
};
<?php
// database/migrations/2025_09_20_000001_add_trip_types_and_tariffs.php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::table('trips', function (Blueprint $t) {
            // 4 типа (ровно один true)
            $t->boolean('type_ab_fixed')->default(false)->index();
            $t->boolean('type_pax_to_pax')->default(false)->index();
            $t->boolean('type_pax_to_b')->default(false)->index();
            $t->boolean('type_a_to_pax')->default(false)->index();

            // тариф у стартовой фикс-точки (A)
            $t->decimal('start_free_km', 8, 2)->nullable();
            $t->unsignedInteger('start_amd_per_km')->nullable();
            $t->decimal('start_max_km', 8, 2)->nullable();

            // тариф у конечной фикс-точки (B)
            $t->decimal('end_free_km', 8, 2)->nullable();
            $t->unsignedInteger('end_amd_per_km')->nullable();
            $t->decimal('end_max_km', 8, 2)->nullable();

            $t->index(['status','departure_at']);
        });
    }
    public function down(): void {
        Schema::table('trips', function (Blueprint $t) {
            $t->dropColumn([
                'type_ab_fixed','type_pax_to_pax','type_pax_to_b','type_a_to_pax',
                'start_free_km','start_amd_per_km','start_max_km',
                'end_free_km','end_amd_per_km','end_max_km',
            ]);
        });
    }
};
<?php
// database/migrations/2025_09_20_000002_add_tariffs_to_trip_stops.php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::table('trip_stops', function (Blueprint $t) {
            $t->decimal('free_km', 8, 2)->nullable()->after('lng');
            $t->unsignedInteger('amd_per_km')->nullable()->after('free_km');
            $t->decimal('max_km', 8, 2)->nullable()->after('amd_per_km');
            $t->index(['trip_id','position']);
        });
    }
    public function down(): void {
        Schema::table('trip_stops', function (Blueprint $t) {
            $t->dropIndex(['trip_id','position']);
            $t->dropColumn(['free_km','amd_per_km','max_km']);
        });
    }
};
<?php
// database/migrations/2025_01_01_000000_add_price_amd_to_ride_requests.php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
public function up(): void {
Schema::table('ride_requests', function (Blueprint $table) {
if (!Schema::hasColumn('ride_requests','price_amd')) {
$table->unsignedInteger('price_amd')->default(0)->after('payment');
}
});
}
public function down(): void {
Schema::table('ride_requests', function (Blueprint $table) {
if (Schema::hasColumn('ride_requests','price_amd')) {
$table->dropColumn('price_amd');
}
});
}
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::table('trips', function (Blueprint $t) {
            $t->unsignedInteger('eta_sec')->nullable()->after('price_amd')->index();
        });
    }
    public function down(): void {
        Schema::table('trips', fn(Blueprint $t) => $t->dropColumn('eta_sec'));
    }
};
<?php
// database/migrations/2025_09_20_000001_add_created_by_to_ride_requests.php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
public function up(): void {
Schema::table('ride_requests', function (Blueprint $t) {
$t->unsignedBigInteger('created_by_user_id')->nullable()->after('user_id');
$t->foreign('created_by_user_id')->references('id')->on('users')->nullOnDelete();
});
}
public function down(): void {
Schema::table('ride_requests', function (Blueprint $t) {
$t->dropForeign(['created_by_user_id']);
$t->dropColumn('created_by_user_id');
});
}
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Str;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('trips', function (Blueprint $table) {
            if (!Schema::hasColumn('trips', 'from_addr_search')) {
                $table->text('from_addr_search')->nullable()->after('from_addr');
            }
            if (!Schema::hasColumn('trips', 'to_addr_search')) {
                $table->text('to_addr_search')->nullable()->after('to_addr');
            }
        });

        $normalizer = fn(?string $value): ?string => $this->normalizeAddress($value);

        DB::table('trips')
            ->select(['id', 'from_addr', 'to_addr'])
            ->orderBy('id')
            ->chunkById(500, function ($rows) use ($normalizer) {
                foreach ($rows as $row) {
                    DB::table('trips')
                        ->where('id', $row->id)
                        ->update([
                            'from_addr_search' => $normalizer($row->from_addr ?? null),
                            'to_addr_search' => $normalizer($row->to_addr ?? null),
                        ]);
                }
            });
    }

    public function down(): void
    {
        Schema::table('trips', function (Blueprint $table) {
            if (Schema::hasColumn('trips', 'from_addr_search')) {
                $table->dropColumn('from_addr_search');
            }
            if (Schema::hasColumn('trips', 'to_addr_search')) {
                $table->dropColumn('to_addr_search');
            }
        });
    }

    private function normalizeAddress(?string $value): ?string
    {
        if ($value === null) {
            return null;
        }

        $trimmed = trim($value);
        if ($trimmed === '') {
            return null;
        }

        $latin = $this->transliterate($trimmed);

        $collapse = Str::of($latin)
            ->lower()
            ->replaceMatches('/[^a-z0-9]+/u', ' ')
            ->squish()
            ->value();

        return $collapse === '' ? null : $collapse;
    }

    private function transliterate(string $value): string
    {
        try {
            return Str::transliterate($value);
        } catch (\Throwable) {
            return Str::ascii($value);
        }
    }
};

<?php
// database/migrations/2025_10_07_000000_create_rider_orders_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('rider_orders', function (Blueprint $t) {
            $t->id();

            $t->foreignId('client_user_id')->constrained('users')->cascadeOnDelete();

            $t->decimal('from_lat', 10, 7)->nullable();
            $t->decimal('from_lng', 10, 7)->nullable();
            $t->string('from_addr')->nullable();
            $t->text('from_addr_search')->nullable();  // нормализованный текст для поиска

            $t->decimal('to_lat', 10, 7)->nullable();
            $t->decimal('to_lng', 10, 7)->nullable();
            $t->string('to_addr')->nullable();
            $t->text('to_addr_search')->nullable();    // нормализованный текст для поиска

            // временное окно или фикс-время (можно заполнять одно поле)
            $t->dateTime('when_from')->nullable();
            $t->dateTime('when_to')->nullable();

            $t->unsignedTinyInteger('seats')->default(1);
            $t->string('payment', 20)->nullable();     // cash|card|...

            $t->unsignedInteger('desired_price_amd')->nullable(); // хотелка клиента

            $t->string('status', 20)->default('open'); // open|matched|closed|cancelled|expired
            $t->json('meta')->nullable();

            $t->timestamps();

            $t->index(['status']);
            $t->index(['client_user_id', 'status']);
            $t->index(['when_from', 'when_to']);
        });
    }

    public function down(): void {
        Schema::dropIfExists('rider_orders');
    }
};
